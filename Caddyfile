# Caddy configuration for gravvisoft.com with automatic HTTPS

# Main site - serves frontend and proxies API
gravvisoft.com {
    # Frontend - serve React build
    root * /srv/frontend
    encode gzip
    file_server

    # API routes - proxy to backend
    handle /api/* {
        uri strip_prefix /api
        reverse_proxy backend:4005
    }

    # Health check endpoint
    handle /health {
        reverse_proxy backend:4005
    }

    # Analytics endpoints
    handle /analytics/* {
        reverse_proxy backend:4005
    }

    # All other API endpoints
    handle /dashboard* {
        reverse_proxy backend:4005
    }

    handle /channel* {
        reverse_proxy backend:4005
    }

    handle /login* {
        reverse_proxy backend:4005
    }

    handle /register* {
        reverse_proxy backend:4005
    }

    handle /lead* {
        reverse_proxy backend:4005
    }

    handle /notes* {
        reverse_proxy backend:4005
    }

    handle /allchannels* {
        reverse_proxy backend:4005
    }

    handle /allvideos* {
        reverse_proxy backend:4005
    }

    handle /newchannels* {
        reverse_proxy backend:4005
    }

    handle /selectleads* {
        reverse_proxy backend:4005
    }

    handle /google* {
        reverse_proxy backend:4005
    }

    handle /ypscrape* {
        reverse_proxy backend:4005
    }

    handle /pullEmail* {
        reverse_proxy backend:4005
    }

    handle /verifyemail* {
        reverse_proxy backend:4005
    }

    handle /seed* {
        reverse_proxy backend:4005
    }

    # WebSocket support for real-time updates
    @websockets {
        header Connection *Upgrade*
        header Upgrade websocket
    }
    handle @websockets {
        reverse_proxy backend:4005
    }

    # SPA fallback - serve index.html for all other routes
    try_files {path} /index.html
}

# Redirect www to non-www
www.gravvisoft.com {
    redir https://gravvisoft.com{uri} permanent
}
